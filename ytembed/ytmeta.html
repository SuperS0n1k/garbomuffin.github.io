<!DOCTYPE html>
<html>
  <head>
    <style>
      pre {
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <p>oh my god this is terrible</p>
    <input id="id-input" type="text">
    <button id="button">get me some metadata</button>

    <div>
      <div>
        <b>Title:</b>
        <code id="title-out"></code>
      </div>

      <div>
        <b>Description:</b>
        <pre id="description-out"></pre>
      </div>

      <div>
        <b>Thumbnail:</b>
        <a id="thumb-out"></a>
      </div>

      <div>
        <b>Tags:</b>
        <code id="tags-out"></code>
      </div>

      <div>
        <b>Channel:</b>
        <a id="channel-out"></a>
      </div>

    </div>


    <script>
      (function() {
        "use strict";
        const idInput = document.getElementById("id-input");
        const button = document.getElementById("button");
        const descriptionOut = document.getElementById("description-out");

        button.addEventListener("click", (e) => {
          const id = idInput.value;

          fetch(`https://garbomuffin.com/api/youtube/video/${id}/meta`)
            .then((r) => r.json())
            .then((data) => {
              data = data.data;
              document.getElementById("description-out").textContent = data.description;
              descriptionOut.textContent = "";
              for (const l of data.description.split("\n")) {
                for (const i of l.split(" ")) {
                  if (isUrl(i)) {
                    const el = document.createElement("a");
                    el.href = i;
                    el.textContent = i;
                    el.target = "_blank";
                    descriptionOut.appendChild(el);
                  } else {
                    descriptionOut.appendChild(document.createTextNode(i));
                  }
                  descriptionOut.appendChild(document.createTextNode(" "));
                }
                descriptionOut.appendChild(document.createTextNode("\n"));
              }

              document.getElementById("title-out").textContent = data.title;

              document.getElementById("thumb-out").href = data.thumbnails.maxres.url;
              document.getElementById("thumb-out").textContent = data.thumbnails.maxres.url;

              document.getElementById("channel-out").textContent = data.channelTitle;
              document.getElementById("channel-out").href = "https://youtube.com/channel/" + data.channelId;

              document.getElementById("tags-out").textContent = data.tags.join(", ") || "none";
            });
        });

        if (location.hash) {
          idInput.value = location.hash.substr(1);
          button.click();
        }

        function isUrl(str) {
          try {
            const url = new URL(str);
            return url.protocol === "https:" || url.protocol === "http:";
          } catch (e) {
            return false;
          }
        }
      }());
    </script>
  </body>
</html>
